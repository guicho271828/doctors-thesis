\section{Depth-Based Tiebreaking for A*}

\label{sec:depth}

The \emph{depth} of a node is an integer value representing the distance
(number of steps) from the \emph{entrance} of the plateau on which the node is.
An \emph{entrance} of the plateau is the first state which entered the
plateau, along the path from the initial state. These notions are depicted
in \refig{fig:plateau-depiction}.

\begin{figure}[htbp]
 \includegraphics{img/astar/final-plateau4.png}
 \caption{The nodes in a platau are divided into several layers,
 and each layor have the corresponding depth.}
 \label{fig:plateau-depiction}
\end{figure}

The depth $d(s)$ of a
state $s$ is 0 when $s$ and the parent state $t$ has the different key
values for a sorting strategy, and $d(s)=d(t)+1$ when they have the same
key values: For example, in \astar with $h$-based tiebreaking, the key
values of a state are represented as a vector $[f,h]$, and they are same
when they are pairwise equivalent (i.e. $f(s) = f(t) \land h(s) =
h(t)$).  Having the same key values means that $s$ and $t$ are in the
same plateau. \todo{Figure}

Based on this simple notion of depth, we propose \emph{depth-based
tiebreaking} strategies, where the nodes are inserted into buckets
associated with depths, and upon expansion, search effort is distributed
among various depths. Notice that it does not ``sort'' the nodes
according to the depth, and instead ``diversify'' the node expansion
within the plateau. We mark such a diversification family of
tiebreaking strategies by enclosing it in brackets such as $[f,h,\depth]$.

In order to diversify the expansion among depths, we propose simply
iterating over the depth buckets. There is a counter $d_c$ initialized
to 0, which stores the depth which was selected in the last expansion.
In each expansion, it decrements the counter ($d_c\leftarrow d_c-1$) and
expands from the depth. When the counter reaches below 0, then the
counter is reset to the current largest depth in the plateau.
It is possible to adopt a
nondeterministic, randomized selection, as we have done in a conference
version of this paper, however we eliminate the possibility of the
results being affected by random seeds.

In contrast, the traditional \lifo and \fifo tiebreaking strategy can be
considered as a ``sorting'' version of this depth-based tiebreaking.
\lifo strategy always select the most recently generated node
within $\plateau{f,h}$, and the behavior in the plateau is equivalent to depth-first search.
Thus, it results in always selecting the largest depth
buckets as depicted in \refig{fig:plateau-depiction-lifo}.
Similarly, the behavior of \fifo strategy 
in a plateau is equivalent to breadth-first search. Thus \fifo strategy
always selects the nodes with least depth (\refig{fig:plateau-depiction-fifo}).
Note that therefore $[f,h,\lifo]$ is equivalent to $[f,h,-d,\lifo]$ and
$[f,h,\fifo]$ is equivalent to $[f,h,d,\fifo]$.

\begin{figure}[htbp]
 \includegraphics{img/astar/final-plateau6.png}
 \caption{\lifo tiebreaking strategy implies a depth-first behavior in a
 plateau, which could miss the solution concentrated near the entrance.}
 \label{fig:plateau-depiction-lifo}
\end{figure}

\begin{figure}[htbp]
 \includegraphics{img/astar/final-plateau5.png}
 \caption{\fifo tiebreaking strategy implies a breadth-first behavior in a
 plateau, which could fail to reach a solution in the deeper region
 within the time limit.}
 \label{fig:plateau-depiction-fifo}
\end{figure}

The problem in these traditional strategies is that we have no knowledge
on whether the goals are located near or far from the entrance. Remind
that when $f=f^*, h=h^*=0$, the goals in this plateau are optimal
regardless of the depth: Goals in the shallower region and the deeper
region both yield an optimal solution. However, until we find a
solution, we do not know how the goals are distributed among the
depths. In some problem instance the goals can be concentrated around
the entrance, and in another problem instance the goals can be
concentrated in some large depth $k$.

% \begin{figure}[htbp]
%  \includegraphics{img/astar/final-plateau4-2.png}
%  \label{fig:plateau-depiction-all-optimal}
% \end{figure}

The best-first search (\fifo), which naturally focus the search around
the entrance favoring the smaller depths, should perform better in the
former case, while it also severely degrade the performance when the
goals are located deep inside the plateau region because it searches the
shallower region exhaustively and takes too much time to reach the depth
where the goals exist.
Exactly the opposite could happend to the depth-first search (\lifo):
\lifo greedily explores the
plateau region and may find a solution in the deeper region quickly but
could also miss the solution in the shallower region.

By an adversary argument, our depth-based \emph{diversification}
tiebreaking strategy, which diversify the search among various depths,
have no depth bias and eventually find a solution.
% It can be considered
% similar to the random restarting strategy in tree search algorithms.

\begin{figure}[htbp]
 \includegraphics{img/astar/final-plateau7.png}
 \caption{Depth-based diversification allows \astar to search the plateau space
 uniformly and sparsely, avoiding the concentration to particular depths, while
 suppressing the excessive exploration to the deeper region. This
 balances the exploration and exploitation.}
 \label{fig:plateau-depiction-all-optimal}
\end{figure}

% We later show that
% \fifo and \lifo strategies are incomplete when the size of the plateau
% region is inifinite, while our \id is probabilistically complete.

\subsection{The Scope Captured by Depth-Based Tiebreaking}

Depth-based tiebreaking has no effect when the key values for measuring
the depth are always updated and thus all nodes have depth 0. A key
value is a single $f$ when $h$-based tiebreaking is not present, and a
pair of $f$ and $h$ when $h$-based tiebreaking is present.  In such
cases, the search is equivalent to the case of traditional last-resort
tiebreaking strategies.
% 
This happens when the target problem contains
positive costs\footnote{not to be confused with non-negative cost} only.
In such a positive-cost problem,
\begin{itemize}
 \item If $f$-value is unchanged after operator application, $g$ value
       should have been increased and thus $h$ value should have been
       decreased if the evaluated node is new.
 \item If $h$-value is unchanged and $g$ is increased, then $f$ is also increased.
\end{itemize}

% %% wrong, since it does not update the parent!
% However, there are still some cases where depth can work even under the
% positive cost domains. This is as follows:
% 
% \begin{itemize}
%  \item When the evaluated nodes are already visited from another parent
%        with smaller $g$ cost, and does not increase the $g$ value, then
%        $h$ value could be same as the parent node.
% \end{itemize}


\subsection{Tiebreaking within Depth Buckets}

Since there can be multiple nodes within the same depth bucket,
a last-resort tiebreaking is still necessary to break ties among them.
We could, for example, apply \lifo, \fifo or \ro policies at this level.

There could be still a room for heuristic-agnostic improvements at
this level, while this is not in the scope of this paper.
For example, while depth metric measures and diversify the depth in a plateau,
other techniques can non-trivially diversify the search in a breadth direction.
They include pruning techniques such as 
symmetry breaking \cite{Fox1998,pochter2011exploiting,domshlak2013symmetry}
or partial order reduction \cite{hall2013faster,wehrle2013relative}.
While these methods are most often described as ``pruning techniques'',
it can be rephrased as ``removing the cardinality bias to particular set
of nodes which shares the same characteristics'' because they both
aim to prune the redundant nodes.

% \todo{compare id,fifo and id,lifo}

% However we use a Random Order (\ro) policy, which 
% randomly selects an element from the depth bucket selected by the depth-based tiebreaking.
% This is because the effectiveness of the tiebreaking behavior within a bucket
% can be affected by accidental biases, e.g., names/orders of action schema in the PDDL domain
% definition \cite{vallati2015effective}.
% %Finding the best action ordering is not the scope of this paper.
% Thus, we avoid bias at this level of tiebreaking by using \ro and assess its expected/average
% performance.

% Among \fifo, \lifo and \ro, the natural policy is Random Order.
% This is because the effectiveness of the third-level tiebreaking behavior
% is affected by the accidental bias in action ordering in the PDDL domain
% definition.  Recent work \cite{vallati2015effective} showed that the
% planner performance is greatly affected by changing and tuning the action ordering
% (and also variable ordering, but it is irrelevant to the tiebreaking behavior). 
% However, finding the best third-level tiebreaking is not the scope of this paper.
% Thus, focusing on \ro and assess its expected/average
% performance is the most reasonable practice to understand the behavior of second-level,
% depth-based tiebreaking.

\subsection{Theoretical Characteristics of the Depth Distribution}

We give further insight into the search behavior of our implementation
of depth-based diversification.
As stated, our implementation iterates from the largest depth to 0.

We are particularly interested in how the expansions happen among the
various depths in the plateau region.
We show that the probability of a node in a particular depth
can be represented by a simple formula.  Although the notion of
probability does not fit well with deterministic \fifo or \lifo
last-resort tiebreaking, it is meaningful in the case of \ro (random
order) last-resort tiebreaking.

%% danger!!
% \begin{theo}[Uniformness of the search]
%  Assume the search space forms a tree of fixed width $w\geq 2$.
%  After enough number of iterations $D$,
%  the chance of expanding each node is unaffected by the depth of the
%  node, if the depth $d$ is small relative to $D$.
% \end{theo}

% I no longer claim the distribution is uniform.
As a preparation, we first show that the number of expansion happened to each depth decreases
linearly to the depth.
% 
Assume that each depth bucket never exhausts as a result of
expansion.  If the expansion of a node in the largest depth $D\geq 0$ resulted
in more nodes in the same plateau, then the newly generated nodes have
depth $D+1$.  Also, as we explained in the previous section, the
expansion is diversified by a sequence of iterations from the current
largest depth to 0.  It means that when the current maximum depth of
the plateau is $D\geq 0$, the number of iteration happened so far is also $D$.
Therefore, at the end of the $D$'th iteration, each depth $d$ has
been expanded exactly $D-d$ times, meaning that the chance of
expanding each depth is decreasing as the depth increase.

% However, it does not mean that this strategy favors the nodes in the
% shallower region.
% This is because the number of nodes in each depth is
% exponential to $d$, which is common in practice (we verify this in the
% later experiments).
Now we show the main theorem.
We assume that the plateau region form a tree of width
$w\geq 2$, rather than a graph with indefinite number of successor
nodes.  Under this assumption, each expansion of depth $d$ results in
$w$ new nodes in depth $d+1$. Also, if there are initially
$D$ nodes in depth 0, each depth bucket never exhausts until the end of $D$'th
iteration (when depth 0 becomes empty).

% $D-d$th expansion in the $D$th iteration expands the depth $d$.
At the end of $D$th iteration,
each depth $d-1$ is expanded $D-(d-1)$ times in the preceeding $D$ iterations.
Therefore, the total number of nodes that have been in depth $d$, including those
that have been expanded so far, is $w(D-d+1)$.
Expansion has happened $D(D-1)$ times in total, and depth $d$ is expanded $D-d$ times.
Thus, the probability of expanding each node in depth $d$ is
$\frac{D-d}{D(D-1)\cdot w(D-d+1)}=\frac{1}{wD(D-1)}(1-\frac{1}{D-d+1})$.

$\frac{1}{D-d+1}$ is negligeble as $D$ increases.
Thus, after enough number of iterations (large $D$), the nodes are 
expanded in an approximately equal probability $\frac{1}{wD(D-1)}$ in the shallower region, and is
unaffected by the depth of the node.
However, the nodes near the largest depth has less probability, showing
some balance in exploration and exploitation. \qed

