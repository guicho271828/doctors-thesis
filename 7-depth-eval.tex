\section{Evaluating Depth-Based Tiebreaking}
\label{sec:depth-based-evaluation}

% this text is mostly repeated below, so deleted this and promoted the subsection below up 1 level.
%% We evaluated our depth-based diversifying tiebreaking strategies against standard
%% tiebreaking strategies.
%% In addition to the 35 IPC benchmark domains with 1104 instances used in
%% the previous set of experiments, we used 28 zerocost domains with 620
%% instances.  

%\subsection{Evaluating Depth-Based Tiebreaking with $h$-tiebreaking}

We compared the performance of standard tiebreaking methods to depth-based tiebreaking methods. These all use $h$
as the first-level tiebreaking and either \fifo, \lifo or \ro (random order) as the default tiebreaking criterion
and the only difference is the presence of the third, depth-diversification criteria.

Experiments are conducted on \textbf{1104 standard IPC benchmark
instances} from 35 domains  and \textbf{620 zerocost instances} from 28 domains (see \refsec{sec:eval-common-strategies} and \refsec{sec:zerocost-domains} for full lists of these domains). 
The basic experimental settings are the same as the previous ones:
Each experiment uses Fast Downward planner using \astar search and either the \lmcut heuristic or \mands heuristic.
Each experiment is run for 5 minutes excluding SAS translation time, with 4GB memory constraints.

We first show the summary results of these experiments (\reftbl{tbl:depth-summary}).
Overall, depth-based tiebreaking tends to show larger coverages than the
standard tiebreaking strategies.

\begin{table}[htb]
 {
 \centering
 \setlength{\tabcolsep}{3pt}
 \input{tables/7-1-summary.tex}
 \caption{
 Main summary results: Coverage comparison (number of instances solved in 5min, 4GB, \lmcut/\mands
 heuristics) between standard tiebreaking and depth-based tiebreaking
 ($\depth$). When \lmcut is used, $\depth$ outperforms standard strategies both in IPC
 instances (1104 problems total) and Zerocost instances (620 problems
 total). When \mands is used, $\depth$ outperforms standard strategies
 in Zerocost instances. \textbf{Bold} shows the best configuration.}
 \label{tbl:depth-summary}
 }
\end{table}

Interestingly, when the depth diversity criterion $\depth$ is used, 
the performance relationship between \lifo and \fifo seems to become the opposite:
\fifo tends to perform better than \lifo in zerocost domains for both
\lmcut and \mands heuristics (299 vs 279 for \lmcut, 317 vs 303 for \mands).
Also, \ro (random order) outperforms both \fifo and \lifo.
In the following, we describe and discuss each experiment.

\reftbl{tbl:lmcut-zerocost-full} and \reftbl{tbl:mands-zerocost-full} shows the number of \textbf{620 zerocost
instances} solved by \lmcut and \mands heuristics. In these
zerocost domains, our proposed method outperforms the traditional tiebreaking methods in both heuristics.
Significant improvements were observed in 10 domains when using \lmcut, and in 7 domains when using \mands.
In detail,
\begin{itemize}
 \item \textbf{10 Domains improved by depth on Zerocost, using \lmcut,} are \pddl{elevators-up} (\ro), \pddl{freecell-move} (\fifo,\ro),
       \pddl{miconic-up} (all), \pddl{mprime-succumb} (\fifo,\ro), \pddl{pipesnt-pushstart} (\ro), \pddl{pipesworld-pushend} (\ro),
       \pddl{scanalyzer-analyze} (\lifo), \pddl{storage-lift} (\fifo), \pddl{tpp-fuel} (\fifo,\ro), \pddl{woodworking-cut} (\fifo,\ro).
 \item \textbf{7 Domains improved by depth on Zerocost, using \mands,} are \pddl{elevators-up} (\ro), \pddl{freecell-move} (\fifo,\ro),
       \pddl{mprime-succumb} (\fifo,\ro), \pddl{pipesnt-pushstart} (\fifo, \ro), \pddl{pipesworld-pushend} (\ro),
       \pddl{tpp-fuel} (\fifo,\ro), \pddl{woodworking-cut} (\fifo,\ro).
\end{itemize}


\begin{table}[htbp]
 {
 \centering
 \input{tables/7-zero-lmcut}
 % 
  \caption{ Coverage comparison (the number of instances solved in 5min, 4GB, \lmcut heuristics) on \textbf{620
 zerocost instances}.  We highlight the best results when the difference between the best and the worst coverages
 is greater than 2.  }
 % 
 \label{tbl:lmcut-zerocost-full}}
\end{table}

\begin{table}[htbp]
 {
 \centering
 \input{tables/7-zero-mands}
  \caption{
 Coverage comparison (the number of instances solved in 5min, 4GB, \mands heuristics)
 on \textbf{620 zerocost instances}. We highlight the
 best results when the difference between the maximum and the minimum coverage exceeds 2.
 }
 \label{tbl:mands-zerocost-full}
 }
\end{table}

\reftbl{tbl:lmcut-ipc-full} shows the number of \textbf{1104 standard IPC benchmark instances} solved by the configuration using \lmcut
heuristics. Depth-based tiebreaking ($\depth$) shows impressive results on \pddl{Openstacks} ($\fifo:2\to 8,\ \lifo:3\to 12,\  \ro:3.9\to 10$) and \pddl{Cybersec} ($\fifo: 11\to 18,\ \ro: 11.7\to 18$) because these
domains contain many instances of zero-cost edges (See
\refig{fig:plateau}).  Most other instances are unaffected by depth-based tiebreaking.  Thus, depth-based
tie-breaking yields better performance in the domains with zero-cost actions, without sacrificing performance in
other domains.

In contrast, \reftbl{tbl:mands-ipc-full} shows that depth-based tiebreaking negatively affects the performance of
the configuration using \mands when applied to \textbf{1104 standard IPC benchmark instances}. Our justification to this result is
the following.
% 
First, the coverage of \pddl{Openstacks} is improved in \fifo ($15\to 19$) and \ro ($15.4\to 19$), so we have achieved the same expected behavior as in the case of \lmcut.
%
While it did not happen to \pddl{Cybersec}, this is due to the poor performance of \mands in \pddl{Cybersec}.
The coverage of \pddl{Cybersec} is 0 in all configurations and even depth could not improve it. Thus, the positive
effect of depth diversification to the overall score was limited.
% 
Second, we observed a performance degradation across a wide range of domains which is caused by the low-level overhead of depth-based tiebreaking (i.e., updates to the depth-based bucket data structures).
As shown in \refig{fig:expansion-ratio}, the number of evaluation of \mands heuristics per seconds has significantly decreased across a wide range of domains, while such an effect is limited in \lmcut.
This is because the evaluation of \mands heuristics is implemented
as an efficient table lookup, and it is able to evaluate an order of magnitude larger number of nodes compared to \lmcut heuristics.
Thus, even the relatively small overhead incurred by the management of depth buckets decreases the node evaluation rate to noticeably degrade performance.
In contrast, \mands did not have such problems in Zerocost domains. This shows that the search efficiency offered by depth based diversification become much more important,
and the low-level overhead became negligible.

% , which is less interesting when tackling an intractable combinatorial problems.

\begin{figure}[htbp]
 \centering
 % \begin{tabular}{cccc}
 %  nodes/sec                  & LMcut      & M\&S       & M\&S slowdown\\
 %  \hline
 %  $[f,h,\lifo]$              & 8.86$\times 10^3$ & 1.37$\times 10^5$ & 100\%\\
 %  $[f,h,\depth,\lifo]$ & 9.37$\times 10^3$ & 1.13$\times 10^5$ & 82\%\\
 %  \hline
 %  $[f,h,\fifo]$              & 9.65$\times 10^3$ & 1.41$\times 10^5$ & 100\%\\
 %  $[f,h,\depth,\fifo]$ & 9.62$\times 10^3$ & 1.24$\times 10^5$ & 87\%\\
 %  \hline
 % \end{tabular}
 % \caption{Comparison of the average node expansion ratio (node/sec) between
 % standard tiebreaking and depth-based tiebreaking on \lmcut and \mands
 % heuristics. Numbers are averaged over the problem instances solved by
 % all 4 configurations. Since the node evaluation of \mands is an order of
 % magnitude faster than \lmcut, the overhead of managing depth-based
 % tiebreaking queue is non-negligible on \mands.}
 \includegraphics{img/node-sec/lmhiF-lmh_F.pdf}
 % \includegraphics{img/node-sec/lmhiL-lmh_L.pdf}
 \includegraphics{img/node-sec/mnhiF-mnh_F.pdf}
 % \includegraphics{img/node-sec/mnhiL-mnh_L.pdf}
 % 
 \caption{Comparison of the node evaluation ratio (node/sec) between standard tiebreaking ($y$-axis) and
 depth-based tiebreaking ($x$-axis) on \lmcut and \mands heuristics. On \mands, compared to \lmcut, node evaluation rate more often becomes
 twice as slower when depth is enabled. This is because the node evaluation of \mands is an order of
 magnitude faster than \lmcut, and the overhead of managing depth-based tiebreaking queue becomes significant. Same results were obtained with \lifo default tiebreaking. }
 % 
 \label{fig:expansion-ratio}
\end{figure}

\begin{table}[htbp]
 {
 \centering
 \input{tables/7-ipc-lmcut}
  \caption{
 Coverage comparison (the number of instances solved in 5min, 4GB, LMcut
 heuristics) on \textbf{1104 standard IPC benchmark instances}. We highlight the
 best results when the difference between the maximum and the minimum coverage exceeds 2.
 }
 \label{tbl:lmcut-ipc-full}
 }
\end{table}

\begin{table}[htbp]
 {
 \centering
 \input{tables/7-ipc-mands}
  \caption{
 Coverage comparison (the number of instances solved in 5min, 4GB, M\&S
 heuristics) on \textbf{1104 standard IPC benchmark instances}. We highlight the
 best results when the difference between the maximum and the minimum coverage exceeds 2.
 }
 \label{tbl:mands-ipc-full}
 }
\end{table}

% \reftbl{tbl:mands-evaluations} shows that if we instead compare the
% number of evaluations on problems solved by both, depth-based
% tiebreaking significantly outperforms the standard tiebreaking
% strategies. Moreover, in the next \textbf{zerocost} domain experiments,
% depth-based tiebreaking ourperforms the standard tiebreaking
% overall. Besides, the coverages by \mands is less than that of \lmcut.

% \begin{figure}[htb]
%  \centering
%  \caption{
%  Comparison of the total number of nodes generated
%  by \mands heuristics until
%  the goal is found, with vs without depth-based tiebreaking.
%  } \label{tbl:mands-evaluations}
% \end{figure}

\clearpage

\subsection{Search Behavior Within a Plateau}

To understand the behavior of depth-based policies, we plotted 
histograms of the depths of search nodes evaluated by several tiebreaking
strategies in the final plateau $\plateau{f^*,0}$ until the solution is
found.  We plotted a depth-based strategy
$[f,h,\depth,\fifo]$, as well as the standard strategies $[f,h,\fifo]$,
$[f,h,\lifo]$ and a single run of randomized strategy $[f,h,\ro]$.

In order to obtain the data for the plot, we added some instrumentation to the strategies which do not use depth-based tiebreaking ($[f,h,\fifo]$, $[f,h,\lifo]$, $[f,h,\ro]$) so that as these strategies run, the depth of each of the expanded nodes is computed (although they do not affect the search behavior).
Note that this instrumentation, which adds some runtime overhead, was \emph{not}
used in the performance comparison experiments above, and were only used for this experiment, which analyzes search behavior.


\refigs{fig:depth-histogram}{fig:depth-histogram3} show the results on exemplary instances from 
various zerocost domains.  We do not show some domains where we did not observe any depths more than 3, in which case
the depth metric has only a negligible impact on the search performance.
We observed very similar results across a wide range of domains as shown in the figures.
It indicates that the depth metric accurately describes the behavior of each tiebreaking criterion.

For example, look at the first figure which is plotting the result of \pddl{depot-fuel}, p07.
\todo*{...Instead of only general trends ... mention specific domains to add some ``color''}
% 
We observed that in the plot of $[f,h,\lifo]$, the depth-first behavior results in deeper search ($\approx 10^3$), while
only a handful of nodes are expanded in the intermediate depth, most often once. Thus,  \lifo's depth-first
behavior has a high possibility of missing the key branch at intermediate depths that may lead to shorter solutions.
On the other hand, the breadth-first behavior of $[f,h,\fifo]$ often gets stuck spending an excessive amount of
time searching around the plateau entrance (expanding $\approx 10^3$ nodes at depth 10).

Also, we noticed that the node distribution by the global randomization $[f,h,\ro]$ is very similar to $[f,h,\fifo]$.
This means that \ro actually behaves very similar to \fifo, which is consistent with the previous performance comparisons.
This is natural, considering that at any given point in the search, more nodes will tend to have shallower depth than deeper depth, and a uniform, random selection will therefore be biased to select a node with shallow depth.
For example, imagine we have 100 nodes at depth $d=1$ and a single node at depth $d=2$.
Since \ro does not consider the depth, the chance of expanding $d=2$ is only $1/101$.
This probability does not improve until a sufficient number of expansions decreases the number of nodes in $d=1$.
Thus, overall behavior of \ro tends to be similar to \fifo, and naive randomization does not solve the problem of heavy bias for shallower depth nodes.

In contrast, $[f,h,\depth,\ro]$ is balancing the search at various depths.
The yellow curve representing $[f,h,\depth,\ro]$ tends to be  almost flat in the shallow depth while gradually decreasing the number of nodes in larger depth.
Moreover, its node distribution almost accurately follows $D-d$, a theoretical model from \refsec{sec:theoretical-characteristics} which assumes a simplified
condition that the plateau forms a tree of fixed branching factor.
$D$ means the largest depth of the unexpanded nodes in the final plateau, which is
larger than the largest depth of the expanded nodes by 1.

The discrepancy of the $[f,h,\depth,\ro]$ curve from the theoretical prediction $D-d$ can be caused by the 
following factors: First, the branching factor of the graph may not be
uniform across the search space. Second, some depth buckets could be
exhausted, as is depicted in the line by $[f,h,\fifo]$ which
shows all nodes in the shallower depths are expanded and the line can be below $D-d$.
Since $[f,h,\fifo]$ exhaustively expands the nodes in shallower depth,
the number of expansion by $[f,h,\fifo]$ in the shallower depths constitutes an upper bound, which may be below $D-d$.

Next, \refig{fig:depth-histogram4} shows the same results on the standard IPC
\pddl{Openstacks} and \pddl{Cybersec} domains.
The result in \pddl{Openstacks} was similar to those of the zerocost domains.
In \pddl{Cybersec},
% while the depth has improved the overall performance,
we found that the performance improvement was not due to the number of nodes in $\plateau{f^*,0}$ because all tiebreaking strategies have generated only a small number of such nodes before the solution was found.
Instead, we observed a large difference in the depth distributions in non-final plateaus $\plateau{f^*,h}, h\not=0$ caused by the difference of tiebreaking.
This suggests that most children of the nodes in $\plateau{f^*,h}$ have $f$ value larger than $f^*$ or stays in $\plateau{f^*,h}$, and the planner is struggling to find nodes with better $h$.
Due to the unbiased search, the depth-based strategy has a better chance of improving $h$ values, finding a node in $\plateau{f^*,0}$ more quickly.
This shows that the depth can also enhance the search in non-final plateaus to find the nodes in the next plateau.
Similar phenomena were observed in several other instances and domains (\refig{fig:depth-histogram5}). To list a few, they are the following: \pddl{depot-fuel}, \pddl{driverlog-fuel}, \pddl{zenotravel-fuel}, \pddl{floortile-ink}, \pddl{mprime-succumb}, \pddl{storage-lift}.
\todo*{might as well say which domains...}

Note that the small number of nodes in $\plateau{f^*,0}$ in this experiment does not contradict the results in \refig{fig:plateau},  which shows that  the number of such nodes is quite large.
This is because \refig{fig:plateau} uses a modified Fast Downward which continues the search until expanding all nodes in the final plateau while in this experiment the planner immediately stops the search after the first solution. These figures are intended to serve different experimental purposes: \refig{fig:plateau} was intended to show the size of the entire final plateau, while \refigs{fig:depth-histogram}{fig:depth-histogram4} were meant to show the actual search behavior. If we were to continue the search after the first solution, all tiebreaking strategies will expand the same set of nodes (in different orders), so we would obtain plots similar to \refig{fig:plateau} regardless of the tiebreaking strategy.

\begin{figure}[htbp]
% \includegraphics{img/output-lmcut/ged-opt14-strips/p17-0.pdf}
\includegraphics{img/output-lmcut/depot-fuel/p07-0.pdf}
\includegraphics{img/output-lmcut/driverlog-fuel/p04-0.pdf}
\includegraphics{img/output-lmcut/elevators-up/p09-0.pdf}
\includegraphics{img/output-lmcut/freecell-move/p04-0.pdf}
\includegraphics{img/output-lmcut/gripper-move/p07-0.pdf}
\includegraphics{img/output-lmcut/logistics00-fuel/p016-0.pdf}
 \caption{(Page 1/5) Number of nodes ($y$-axis) expanded per depth ($x$-axis) in
 the final plateau with different tiebreaking strategies. Both axes are in logarithmic scale.
 }
 \label{fig:depth-histogram}
\end{figure}

\begin{figure}[htbp]
\includegraphics{img/output-lmcut/miconic-up/p79-0.pdf}
\includegraphics{img/output-lmcut/pathways-fuel/p03-0.pdf}
\includegraphics{img/output-lmcut/pipesnt-pushstart/p06-0.pdf}
\includegraphics{img/output-lmcut/pipesworld-pushend/p06-0.pdf}
\includegraphics{img/output-lmcut/psr-small-open/p46-0.pdf}
\includegraphics{img/output-lmcut/rovers-fuel/p07-0.pdf}
 \caption{(Page 2/5) Number of nodes ($y$-axis) expanded per depth ($x$-axis) in
 the final plateau with different tiebreaking strategies. Both axes are in logarithmic scale.
 }
 \label{fig:depth-histogram2}
\end{figure}

\begin{figure}[htbp]
\includegraphics{img/output-lmcut/scanalyzer-analyze/p04-0.pdf}
\includegraphics{img/output-lmcut/storage-lift/p11-0.pdf}
\includegraphics{img/output-lmcut/tidybot-motion/p16-0.pdf}
\includegraphics{img/output-lmcut/tpp-fuel/p08-0.pdf}
\includegraphics{img/output-lmcut/woodworking-cut/p04-0.pdf}
\includegraphics{img/output-lmcut/zenotravel-fuel/p07-0.pdf}
 \caption{(Page 3/5) Number of nodes ($y$-axis) expanded per depth ($x$-axis) in
 the final plateau with different tiebreaking strategies. Both axes are in logarithmic scale.
 }
 \label{fig:depth-histogram3}
\end{figure}

\begin{figure}[htbp]
\includegraphics{img/output-lmcut/openstacks-opt11-strips/p07-0.pdf}
\includegraphics{img/output-lmcut/cybersec/p06-0.pdf}
\includegraphics{img/output-lmcut/cybersec/p06-1.pdf}
\includegraphics{img/output-lmcut/cybersec/p06-5.pdf}
% \includegraphics{img/output-lmcut/cybersec/p06-6.pdf}
\includegraphics{img/output-lmcut/cybersec/p07-0.pdf}
% \includegraphics{img/output-lmcut/cybersec/p07-1.pdf}
\includegraphics{img/output-lmcut/cybersec/p07-94.pdf}
% \includegraphics{img/output-lmcut/cybersec/p07-95.pdf}
 \caption{(Page 4/5) Depth distribution of \pddl{Openstacks} and \pddl{Cybersec} instances in the final ($\plateau{f^*,0}$) and non-final plateaus ($\plateau{f^*,h}, h\not=0$). In \pddl{Cybersec} p06, although the number of nodes generated in $\plateau{f^*,0}$ is small, \fifo and \ro behaved poorly on $\plateau{f^*,1}$, and also \lifo behaved poorly on $\plateau{f^*,5}$. The same behavior was observed in p07.}
 \label{fig:depth-histogram4}
\end{figure}

\begin{figure}[htbp]
\includegraphics{img/output-lmcut/depot-fuel/p07-1.pdf}
\includegraphics{img/output-lmcut/driverlog-fuel/p04-1.pdf}
\includegraphics{img/output-lmcut/zenotravel-fuel/p07-1.pdf}
\includegraphics{img/output-lmcut/floortile-ink/p02-14.pdf}
\includegraphics{img/output-lmcut/mprime-succumb/p12-1.pdf}
\includegraphics{img/output-lmcut/storage-lift/p12-2.pdf}
 \caption{(Page 5/5) Depth distribution in the non-final plateaus ($\plateau{f^*,h}, h\not=0$): Other domains.}
 \label{fig:depth-histogram5}
\end{figure}

